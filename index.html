<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>mathsys</title>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/msgpack-lite/0.1.26/msgpack.min.js"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>

  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> -->
  <link href="bootstrap.css" rel="stylesheet">

  <script type="text/javascript">

    var dta=null;
    dta = fetchMsgpack("content.dta");

   function checkDtaReady(){   // if NOT ready, wait 1/2 s
     if (dta==null){
         setTimeout(checkDtaReady,500)
     }else {
          renderQuestion(1);
     }
   }
    window.MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'],
          ['\\(', '\\)']
        ]
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
           MathJax.startup.promise.then(() => { });
           checkDtaReady();
        }
      }
    };

    function intersection(setA, setB) {
      let setC = new Set();

      for (let v of setB) {
        if (setA.has(v)) setC.add(v);
      }
      return setC;
    };

    function getSections() {

      let chap=dta["chap"];
      let contents=dta["contents"];

      let sectns = [];
      for (let key in contents) {

        if (key.includes('_')) {
          if (key.split('_')[0]==chap){
            sectns.push([key,contents[key]])
        }}
      };
      return sectns;
    }

    function updProbSelection() {

      let chap=dta["chap"]
      let secs=dta["secs"]
      let levs=dta["levs"]

      let Probs = [];
      let levSet=new Set()
      let secSet=new Set()

      for (sec of secs){
          if (dta[sec].length>0){
             dta[sec].forEach(item=>secSet.add(item));
           }
        }
        for (lev of levs){
            if (dta[chap+"_"+lev].length>0){
               dta[chap+"_"+lev].forEach(item=>levSet.add(item));
             }
          }
      let probNrs=intersection(levSet,secSet)

      for (nr of probNrs){
        Probs.push(...dta[nr])
      }
      selection=[];
      i=0;
      while( i<10 ) {
      var index = Math.floor( Math.random()*Probs.length );
      selection.push(Probs[index]);
      Probs.splice( index, 1 );
      i+=1;
  }
      dta["probs"]=selection
    };

    function renderQuestion(id) {
      // DATA
      let qRAW = msgpack.decode(dta["probs"][id - 1]);

      // RENDERING
      let q_node = document.getElementById("question");
      let s_node = document.getElementById("solution");
      q_node.innerHTML=qRAW[0];
      s_node.innerHTML = qRAW[1];
      MathJax.typeset([q_node, s_node]);
    };

   function renderNavbar(){
     let chapters=dta["chapters"]

     var el = document.getElementById('main_navbar');
     for (var i = 0; i < chapters.length; i++) {
       var node = document.createElement("li");
       node.classList.add("nav-item", "active");

       var link = document.createElement("a");
       link.classList.add("nav-link");
       link.setAttribute('href', chapters[i][0]);
       link.innerHTML = chapters[i][0] + " " + chapters[i][1];
       node.appendChild(link);
       el.appendChild(node);
     };
   }

   function renderPagination(){

     var el = document.getElementById('pagination');
     for (var i = 1; i < 11; i++) {
       var node = document.createElement("li");
       var link = document.createElement("a");

       node.classList.add("page-item");
       if (i == 1) {
         node.classList.add("active");
         link.setAttribute("id","but1");
       }
       link.classList.add("page-link");
       link.setAttribute('href', '?page=' + i);
       link.innerHTML = i;
       node.appendChild(link);
       el.appendChild(node);
     };
   }

   function renderSections() {

     sections=getSections()
     var el = document.getElementById('sections');
     el.innerHTML="";

     for (var i = 0; i < sections.length; i++) {

       var div = document.createElement("div");
       div.classList.add("form-check");

       var input = document.createElement("input");
       input.classList.add("form-check-input", "mx-2");
       input.setAttribute("type", "checkbox");
       input.setAttribute("name", "secs");
       input.setAttribute("value", sections[i][0]);
       input.setAttribute("id", sections[i][0])
       if (i == 0) {
         input.setAttribute("checked", "")
       }
       div.appendChild(input);
       var label = document.createElement("label");
       label.classList.add("form-check-label", "mx-1");
       label.setAttribute("for", sections[i][0]);
       label.innerHTML = sections[i][1];
       div.appendChild(label);
       el.appendChild(div);
     }
   };

   function renderLevels(){

     levels=["l1","l2","l3"]
     var el = document.getElementById('level');

     for (var i = 1; i < levels.length+1; i++) {

       var div = document.createElement("div");
       div.classList.add("form-check");

       var input = document.createElement("input");
       input.classList.add("form-check-input", "mx-2");
       input.setAttribute("type", "checkbox");
       input.setAttribute("name", "levs");
       input.setAttribute("value", levels[i-1]);
       input.setAttribute("id", levels[i-1])
       if (i == 1) {
         input.setAttribute("checked", "")
       }

       div.appendChild(input);

       var label = document.createElement("label");
       label.classList.add("form-check-label", "mx-1");
       label.setAttribute("for", levels[i-1]);
       label.innerHTML = "level " + i;
       div.appendChild(label);
       el.appendChild(div);
     }
   };

   function handleNavbar(){

           var navs = document.querySelectorAll(".nav-link");
           for (nav of navs) {

             nav.addEventListener('click', function(ev) {
               ev.preventDefault();
               let chap = ev.target.getAttribute('href');

               dta["chap"]=chap
               let sections=getSections();
               dta["secs"]=[sections[0][0]];

               updProbSelection();

               // RENDER updated probs

               renderSections();
               but1=document.getElementById("but1")
               var clickEvent = new Event( 'click' );
               but1.dispatchEvent( clickEvent );
               renderQuestion(1);
               document.getElementById("settings").classList.remove("show");
               document.getElementById("collapsibleNavbar").classList.remove("show");

             });
           }
        };

    function handlePagination(){

            var pagBttns = document.querySelectorAll(".page-item");
            for (but of pagBttns) {

              but.addEventListener('click', function(ev) {
                ev.preventDefault();
                document.getElementById("solution").classList.remove("show");

                but = ev.target;
                var pagButtns = document.querySelectorAll(".page-item");
                for (pagButt of pagButtns) {
                  pagButt.classList.remove('active');
                };
                but.parentElement.classList.add('active');
                var page = but.getAttribute('href').match(/\d+/);

                if (page == null) {
                  page = 1
                };
                renderQuestion(page);
              }, false)
            };
    }
    function handleFormUpdate(){
      document.querySelector("#updatebtn").addEventListener('click', function (ev){

        ev.preventDefault();

        // get FORM data
        const form = document.querySelector("form");  //ev.target
        const FD = new FormData( form );

        dta["secs"]=FD.getAll("secs")
        dta["levs"]=FD.getAll("levs")

        // update DATA
        updProbSelection();

        // RENDER updated probs
        document.getElementById("settings").classList.remove("show");
        but1=document.getElementById("but1")
        var clickEvent = new Event( 'click' );
        but1.dispatchEvent( clickEvent );
        renderQuestion(1);
      },false);
    };

    window.onload = function() {

    }

    function fetchMsgpack(url, method = "GET") {

      fetch(url, {
        method: '' + method,
        credentials: "same-origin",
      }).then(function(response) {
        return response.arrayBuffer();
      }).then(function(buff) {

        // DATA
        uint8buff = new Uint8Array(buff);
        dta = msgpack.decode(uint8buff);

        sections=getSections()
        dta["secs"]=[sections[0][0]]
        dta["levs"]=["l1"]
        updProbSelection();

        // RENDER data

          document.getElementById("main_title").innerHTML = dta["title"];
          renderNavbar();
          renderPagination(10);
          renderSections();
          renderLevels();
          document.getElementById("settings").classList.remove("show");

          handleNavbar();
          handleFormUpdate()
          handlePagination();

          document.getElementById("spinner").remove();
          document.getElementById("chief").classList.add("show");

      });
    }

  </script>
  <style>
    .item-a {
      grid-column-start: 2;
      grid-column-end: 4;
      grid-row-start: 1;
      grid-row-end: 2;
    }

    .item-b {
      grid-column-start: 1;
      grid-column-end: 2;
      grid-row-start: 2;
      grid-row-end: 3;
    }

    .item-c {
      grid-column-start: 2;
      grid-column-end: 4;
      grid-row-start: 2;
      grid-row-end: 3;
    }

    .item-d {
      grid-column-start: 4;
      grid-column-end: 5;
      grid-row-start: 2;
      grid-row-end: 3;
    }

    .item-e {
      grid-column-start: 1;
      grid-column-end: 3;
      grid-row-start: 3;
      grid-row-end: 4;
    }

    .item-f {
      grid-column-start: 3;
      grid-column-end: 5;
      grid-row-start: 3;
      grid-row-end: 4;
    }

    .main_container {
      margin: 10px 30px 10px;
      display: grid;
      grid-template-columns: 5% 45% 35% 5%;
      grid-template-rows: 25% 65% 10%;
      column-gap: 10px;
      row-gap: 15px;
    }
  </style>
</head>

<body>

  <nav class="navbar  navbar-dark bg-primary">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
      <span class="navbar-toggler-icon"> </span>
    </button>
    <div class="collapse navbar-collapse" id="collapsibleNavbar">
      <ul class="navbar-nav" id="main_navbar">
      </ul>
    </div>
  </nav>

  <div class="d-flex justify-content-center collapse show" id="spinner" >
      <strong>Loading...</strong>
    <div class="spinner-border my-5" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="main_container collapse " id="chief">

    <div class="item item-a">
      <!-- main title -->
      <h1 id="main_title"> </h1>
      <ul class="pagination pagination-sm justify-content-center" id="pagination">
      </ul>
    </div> <!-- main title -->

    <div class="item item-b">
      <!-- left TOOLBAR -->

    </div> <!-- left TOOLBAR -->

    <div class="item item-c">
      <!-- MAIN section -->

      <nav class="navbar navbar-light bg-light font-weight-bold px-2" id="opgave">
        OPGAVE
        <button class="navbar-toggler btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#settings">
          <span class="navbar-toggler-icon" style="font-size:10px;"></span>
        </button>
      </nav>

        <div class="collapse show" id="settings">

          <form action="javascript:void(0);" method="post" class="inline-form" id="pb">
            <div class="container ">
              <div class="row justify-content-around text-white bg-primary m-3 p-2">
                <div class="m-2 text-uppercase text-decoration-underline" id="sections">onderdeel</div>
                <div class="m-2 text-uppercase text-decoration-underline" id="level">level</div>
              </div>
            </div>

            <div class="justify-content-center">
              <button type="submit" class="btn btn-primary m-3" id="updatebtn">Update</button>
            </div>
          </form>
        </div>


      <div id="question">
      </div>
      <hr />
      <div class="dropdown">
        <button class="btn btn-primary " type="button" data-bs-toggle="collapse" data-bs-target="#solution">Oplossing </button>
        <div class="collapse" id="solution">
        </div>
      </div>
    </div>

    <div class="item item-d">
      <!-- RIGHT toolbar  -->
    </div>

    <div class="item item-e">
      <!-- LEFT footer -->
    </div>

    <div class="item item-f">
      <!-- RIGHT footer  -->
    </div>

  </div>
</body>
</html>
